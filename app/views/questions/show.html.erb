<div class="container">
  <!--使いやすいように上にも追加-->
  <div class="text-right">
    <!--この質問をしたユーザーであれば修正を許可-->
    <%if current_user != nil%>
      <% if current_user.id == @question.user_id %>
        <%= link_to '編集', edit_question_path(@question) %> |
      <% end %>
    <% end %>
    <%= link_to '戻る', questions_path %>
  </div>
  <header class="jumbotron my-4">
    <h2 class="card-title"><%= @question.title %></h2>
    <!--ここにボタン形式でタグを表示-->
    <% @question.tags.each do |tag| %>
      <button class="btn btn-info"><%= tag.name %></button>
    <% end %>

    <% if user_signed_in? %>
      <% if current_user.already_evaluation?(@question) %>
        <%= link_to question_evaluation_path(@question), method: :delete do%>
          <i class="fas fa-heart"></i>
        <%end%>
      <% else %>
        <%= link_to question_evaluation_path(@question), method: :post do%>
          <i class="far fa-heart"></i>
        <%end%>
      <% end %>
    <% else %>
          <i class="far fa-heart"></i>
    <% end %>
    <%= @question.evaluations.count%>
    <small class="text-muted updated">更新日：<%= @question.updated_at.strftime("%Y-%m-%d") %></small>
  </header>
  <div class="card-body">
    内容：<br><%= @question.body %><br>
 
    質問ユーザー：<span><%= @question.user.username %></span>
  </div>
  <!--ここから下が回答-->
  <div class="row">
    <!-- @questionがたくさん持っている(has_manyな)answersをloopさせて一つずつ表示
    has_manyなデータを取得するときは、配列でデータを取得します。 -->
    <% @question.answers.each do |answer| %>
      <div class="col-lg-11 col-md-11">
        <div class="card h-100">
        <!--ベストアンサーの色を変更するための修正-->
        <div class="card-body  <%= "best-answer" if @question.best_answer_id == answer.id %>">
            <div><%= answer.body %></div>
            <p class="text-right">
              <span>
                回答ユーザー：<%= answer.user.username %>
              </span>
            </p>
            <% answer.reactions.each do |reaction| %>
              <div class="row">
                <div class="col-lg-12 col-md-12">
                  <div class="card h-100">
                    <div class="card-body">
                      <div><%= reaction.body %></div>
                      <p class="text-right">
                        <span>
                          回答ユーザー：<%= reaction.user.username %>
                        </span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <br>
            <% end %>
            <!-- ベストアンサーが決まっていたら修正ができないようにする best_answer_idがなければ表示される -->
            <p class="text-right"><%= link_to 'コメントする', new_answer_reaction_path(answer.id) %></p>
          </div>
        </div>
      </div>
      <%if current_user != nil%>
        <% if @question.user.id == current_user.id && @question.best_answer_id == nil %>
          <div class="col-lg-1 col-md-1 ba-parent">
            <!--disablesと確認ダイアログを追加-->
            <div class="ba-child text-center">
              <%= form_with(model: @question, local: true, data: {confirm: "#{answer.user.username}さんの回答をベストアンサーにします。よろしいですか？"}) do |form| %>
                <%= form.hidden_field :best_answer_id, value: answer.id %>
                <div class="actions">
                  <%= form.submit 'ベストアンサー'%>
                </div>
              <% end %>
            </div>
          </div>
        <% elsif @question.user.id == current_user.id && @question.best_answer_id != nil && answer.id == @question.best_answer_id %>
          <div class="col-lg-1 col-md-1 ba-parent">
            <!--disablesと確認ダイアログを追加-->
            <div class="ba-child text-center">
              <%= form_with(model: @question, local: true, data: {confirm: "をベストアンサーを取り消します。よろしいですか？"}) do |form| %>
                <%= form.hidden_field :best_answer_id, value: nil %>
                <div class="actions">
                  <%= form.submit 'ベストアンサーを取り消す' %>
                </div>
              <% end %>
            </div>
          </div>
        <%end%>
      <% end %>
    <% end %>
  </div>
  <div class="text-right">
  <%if current_user != nil%>
    <% if current_user.id == @question.user_id %>
      <%= link_to '編集', edit_question_path(@question) %> |
      <%= link_to '削除する', @question , method: :delete, data: { confirm: '本当によろしいですか？'} %> |
    <% end %>
  <% end %>
  <%= link_to '戻る', questions_path %>
  </div>
</div>

<!--
# <p id="notice"><%= notice %></p>

# <p>
#   <strong>User:</strong>
#   <%= @question.user_id %>
# </p>

# <p>
#   <strong>Title:</strong>
#   <%= @question.title %>
# </p>

# <p>
#   <strong>Body:</strong>
#   <%= @question.body %>
# </p>

# <%= link_to 'Edit', edit_question_path(@question) %> |
# <%= link_to 'Back', questions_path %>
-->